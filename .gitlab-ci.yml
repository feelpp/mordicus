image: python:3.7-alpine

variables:
  MYPROJECT : 'mordicus'

stages:
  - doc
  - test
  - deploy

doc:
  stage: doc
  image: python:3.7-alpine
  before_script:
    - apk add build-base
    - pip install -U sphinx
  script:
    - pwd
    - export PYTHONPATH=$PWD/../basic-tools/src:$PYTHONPATH
    - mkdir -p public
    - cd src/poc-1/doc
    - make html
    - mv _build/html ../../../public/doc
  artifacts:
    name: "Documentation"
    paths:
      - public/doc

.test:
  stage: test
  image: python:3.7
  before_script:
    - pwd
    - apt-get update
    - apt-get install -y python3-venv gcc python3-dev libopenmpi-dev make
    - pip install --upgrade pip
    - pip install -r ./requirements.txt
    - export PYTHONPATH=$PWD/../basic-tools/src:$PYTHONPATH

poc-1:
  extends: .test
  script:
    - pwd
    - export PYTHONPATH=$PWD/src/poc-1/src:$PYTHONPATH
    - mkdir -p public/coverageReportCore
    - cd src/poc-1/tests/Core
    - pytest --cov=../../src/Mordicus/Core --cov-report=html:../../../../public/coverageReportCore
    - cd ../../../../public/coverageReportCore
    - grep pc_cov index.html
  coverage: '/pc_cov">([0-9]+\.?[0-9]+?%)/'
  artifacts:
    name: "CoverageCore"
    paths:
      - public/coverageReportCore


image: alpine:latest

pages:
  stage: deploy
  script:
    - pwd
    - echo 'Nothing to do...'
  artifacts:
    paths:
    - public/
  only:
  - master

